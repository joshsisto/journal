{% extends "base.html" %}

{% block title %}Journal Dashboard{% endblock %}

{% block styles %}
<style>
    /* Enhanced Dashboard - Compact, Tight UI Design with Theme Support */
    body {
        background: var(--bg-secondary);
        color: var(--text-primary);
        transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    .container {
        max-width: none;
        width: 100%;
        padding: 8px 16px;
    }
    
    .main-container {
        max-width: none;
        padding: 0;
        margin: 0;
    }
    
    /* Compact header */
    .dashboard-header {
        margin-bottom: 12px;
        padding: 8px 0;
    }
    
    .dashboard-header h1 {
        font-size: 1.5rem;
        margin: 0;
        font-weight: 600;
        color: var(--text-primary);
    }
    
    /* Compact writing area */
    .writing-section {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 12px;
        margin-bottom: 16px;
    }
    
    .writing-textarea {
        width: 100%;
        min-height: 120px;
        border: none;
        resize: vertical;
        font-size: 14px;
        line-height: 1.4;
        padding: 8px;
        background: var(--bg-secondary);
        border-radius: 3px;
        color: var(--text-primary);
    }
    
    .writing-textarea:focus {
        outline: none;
        background: var(--bg-primary);
        border: 1px solid var(--accent-color);
    }
    
    .writing-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid var(--border-color);
    }
    
    .word-count {
        font-size: 12px;
        color: var(--text-secondary);
    }
    
    .action-buttons {
        display: flex;
        gap: 6px;
        align-items: center;
    }
    
    .save-btn, .toggle-btn {
        background: var(--accent-color);
        color: white;
        border: none;
        padding: 6px 16px;
        border-radius: 3px;
        font-size: 13px;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    
    .small-btn {
        padding: 6px 8px;
        font-size: 14px;
        min-width: auto;
    }
    
    .save-btn:hover, .toggle-btn:hover {
        background: #339af0;
    }
    
    .toggle-btn.active {
        background: #28a745;
    }
    
    .toggle-btn.active:hover {
        background: #218838;
    }
    
    /* Template dropdown */
    .template-dropdown-container {
        position: relative;
    }
    
    .template-select {
        background: var(--accent-color);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 3px;
        font-size: 13px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        min-width: 100px;
    }
    
    .template-select:hover {
        background: #339af0;
    }
    
    .template-select:focus {
        outline: none;
        background: #339af0;
    }
    
    /* Template select options */
    .template-select option {
        background: var(--bg-primary);
        color: var(--text-primary);
        padding: 4px 8px;
    }
    
    /* Guided questions section - Compact Design */
    .guided-section {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 12px;
        margin-bottom: 16px;
        animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            max-height: 0;
            padding: 0 12px;
        }
        to {
            opacity: 1;
            max-height: 800px;
            padding: 12px;
        }
    }
    
    .guided-questions {
        display: grid;
        gap: 8px;
        margin-bottom: 12px;
    }
    
    .question-item {
        display: grid;
        grid-template-columns: 180px 1fr;
        gap: 8px;
        align-items: center;
        padding: 4px 0;
    }
    
    .question-item.full-width {
        grid-template-columns: 1fr;
        gap: 4px;
    }
    
    .question-label {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
        margin: 0;
    }
    
    .question-input {
        padding: 6px 8px;
        border: 1px solid var(--border-color);
        border-radius: 3px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 13px;
        resize: vertical;
        min-height: 24px;
    }
    
    .question-input:focus {
        outline: none;
        border-color: var(--accent-color);
        background: var(--bg-primary);
    }
    
    .question-input.textarea {
        min-height: 60px;
        font-family: inherit;
    }
    
    /* Interactive emoji slider */
    .feeling-scale-container {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .feeling-slider {
        width: 100%;
        height: 6px;
        background: var(--border-color);
        border-radius: 3px;
        outline: none;
        appearance: none;
    }
    
    .feeling-slider::-webkit-slider-thumb {
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--accent-color);
        cursor: pointer;
    }
    
    .feeling-slider::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--accent-color);
        cursor: pointer;
        border: none;
    }
    
    .feeling-display {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
    }
    
    .feeling-current {
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 500;
    }
    
    .feeling-emoji {
        font-size: 18px;
    }
    
    /* Compact emotion selector */
    .emotion-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        max-height: 80px;
        overflow-y: auto;
    }
    
    .emotion-tag {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 2px 6px;
        border-radius: 8px;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.15s ease;
        white-space: nowrap;
    }
    
    .emotion-tag:hover {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }
    
    .emotion-tag.selected {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }
    
    .emotion-tag.positive {
        border-color: #28a745;
    }
    
    .emotion-tag.negative {
        border-color: #dc3545;
    }
    
    .emotion-tag.neutral {
        border-color: #6c757d;
    }
    
    .emotion-tag.positive.selected {
        background: #28a745;
    }
    
    .emotion-tag.negative.selected {
        background: #dc3545;
    }
    
    .emotion-tag.neutral.selected {
        background: #6c757d;
    }
    
    .guided-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 8px;
        border-top: 1px solid var(--border-color);
    }
    
    .question-progress {
        font-size: 11px;
        color: var(--text-secondary);
    }
    
    .guided-action-buttons {
        display: flex;
        gap: 6px;
    }
    
    /* Weather and location section - Streamlined design */
    .weather-section {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 12px;
        margin-bottom: 16px;
        animation: slideDown 0.3s ease-out;
    }
    
    .weather-controls {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .weather-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .weather-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }
    
    .weather-actions {
        display: flex;
        gap: 6px;
    }
    
    .weather-btn {
        background: var(--accent-color);
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 11px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        min-width: auto;
    }
    
    .weather-btn:hover {
        background: #339af0;
    }
    
    .weather-btn.clear-btn {
        background: #dc3545;
    }
    
    .weather-btn.clear-btn:hover {
        background: #c82333;
    }
    
    .weather-btn:disabled {
        background: var(--text-secondary);
        cursor: not-allowed;
    }
    
    .location-search-container {
        display: flex;
        gap: 4px;
        margin-bottom: 8px;
    }
    
    .location-input {
        flex: 1;
        padding: 6px 8px;
        border: 1px solid var(--border-color);
        border-radius: 3px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 12px;
    }
    
    .location-input:focus {
        outline: none;
        border-color: var(--accent-color);
        background: var(--bg-primary);
    }
    
    .location-input::placeholder {
        color: var(--text-secondary);
        font-style: italic;
    }
    
    .search-btn {
        background: #6f42c1;
        color: white;
        border: none;
        padding: 6px 8px;
        border-radius: 3px;
        font-size: 11px;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    
    .search-btn:hover {
        background: #5a32a3;
    }
    
    .weather-display {
        padding: 8px;
        background: var(--bg-secondary);
        border-radius: 3px;
        font-size: 12px;
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        min-height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .weather-content {
        text-align: center;
    }
    
    .weather-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .weather-temp {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .weather-condition {
        font-size: 12px;
        color: var(--text-secondary);
    }
    
    .location-info {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 4px;
    }
    
    .weather-status {
        color: var(--text-secondary);
        font-style: italic;
        font-size: 12px;
    }
    
    .weather-loading {
        color: var(--accent-color);
        animation: pulse 1.5s ease-in-out infinite alternate;
    }
    
    @keyframes pulse {
        from { opacity: 1; }
        to { opacity: 0.5; }
    }
    
    /* Compact entries section */
    .entries-section {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 12px;
    }
    
    .entries-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .entries-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }
    
    .toggle-container {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .toggle-label {
        font-size: 12px;
        color: var(--text-secondary);
        margin: 0;
    }
    
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 40px;
        height: 20px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--border-color);
        transition: .3s;
        border-radius: 20px;
    }
    
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 2px;
        bottom: 2px;
        background-color: var(--bg-primary);
        transition: .3s;
        border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
        background-color: var(--accent-color);
    }
    
    input:checked + .toggle-slider:before {
        transform: translateX(20px);
    }
    
    /* Compact entry items */
    .entry-item {
        border-bottom: 1px solid var(--border-color);
        padding: 8px 0;
        margin: 0;
        transition: background-color 0.2s ease;
    }
    
    .entry-item:hover {
        background-color: var(--bg-secondary);
        border-radius: 4px;
        margin: 0 -8px;
        padding: 8px 8px;
    }
    
    .entry-item:last-child {
        border-bottom: none;
    }
    
    .entry-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }
    
    /* Entry body with content on left, context on right */
    .entry-body {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
    }
    
    .entry-main-content {
        flex: 1;
        min-width: 0; /* Allow content to shrink */
    }
    
    .entry-context {
        flex-shrink: 0;
        max-width: 180px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        align-items: flex-end;
    }
    
    .entry-type {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 2px 6px;
        border-radius: 2px;
        line-height: 1;
    }
    
    .entry-type.quick {
        background: #e3f2fd;
        color: #1976d2;
    }
    
    [data-theme="dark"] .entry-type.quick {
        background: #1565c0;
        color: #e3f2fd;
    }
    
    .entry-type.guided {
        background: #f3e5f5;
        color: #7b1fa2;
    }
    
    [data-theme="dark"] .entry-type.guided {
        background: #6a1b9a;
        color: #f3e5f5;
    }
    
    .entry-date {
        font-size: 11px;
        color: var(--text-secondary);
    }
    
    .entry-content {
        font-size: 13px;
        line-height: 1.4;
        color: var(--text-primary);
        margin: 4px 0;
    }
    
    /* Guided entry specific */
    .guided-summary {
        background: var(--bg-secondary);
        padding: 6px 8px;
        border-radius: 3px;
        margin: 4px 0;
        font-size: 12px;
    }
    
    .feeling-indicator {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .emotion-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 3px;
        margin-top: 4px;
    }
    
    .emotion-tag {
        background: #e8f5e8;
        color: #2e7d32;
        padding: 1px 4px;
        border-radius: 2px;
        font-size: 10px;
        font-weight: 500;
    }
    
    /* Detailed view content */
    .detailed-only {
        display: none;
    }
    
    .show-detailed .detailed-only {
        display: block;
    }
    
    .show-detailed .guided-summary {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        padding: 8px;
    }
    
    .context-info {
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px solid var(--border-color);
        font-size: 11px;
        color: var(--text-secondary);
    }
    
    .context-item {
        display: inline-block;
        margin-right: 8px;
    }
    
    /* Right-side weather and location display */
    .entry-weather-info {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 6px 8px;
        font-size: 11px;
        text-align: right;
        min-width: 100px;
    }
    
    .weather-temp {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 2px;
    }
    
    .weather-condition {
        font-size: 10px;
        color: var(--text-secondary);
        margin-bottom: 4px;
    }
    
    .entry-location-info {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 4px 6px;
        font-size: 10px;
        color: var(--text-secondary);
        text-align: right;
        max-width: 140px;
        word-wrap: break-word;
    }
    
    .location-name {
        font-weight: 500;
        color: var(--text-primary);
    }
    
    /* Entry actions */
    .entry-actions {
        margin-top: 4px;
        display: flex;
        gap: 6px;
    }
    
    .entry-action {
        font-size: 11px;
        color: var(--accent-color);
        text-decoration: none;
        padding: 2px 4px;
        border-radius: 2px;
    }
    
    .entry-action:hover {
        background: var(--bg-secondary);
        color: var(--accent-color);
    }
    
    /* Pagination */
    .pagination-wrapper {
        margin-top: 16px;
        padding-top: 12px;
        border-top: 1px solid var(--border-color);
        text-align: center;
    }
    
    .pagination-info {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 8px;
    }
    
    .pagination-nav {
        display: flex;
        justify-content: center;
        gap: 8px;
    }
    
    .pagination-btn {
        padding: 4px 8px;
        font-size: 12px;
        border: 1px solid var(--border-color);
        background: var(--bg-primary);
        color: var(--text-secondary);
        text-decoration: none;
        border-radius: 3px;
    }
    
    .pagination-btn:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
    }
    
    .pagination-btn.active {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }
    
    /* Wide screen layout - side by side */
    @media (min-width: 1200px) {
        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: start;
        }
        
        .writing-entries-container {
            display: contents;
        }
        
        /* Removed max-height and overflow-y to prevent double scrolling */
        .entries-section {
            /* Natural height based on content */
        }
    }
    
    /* Tablet and desktop - tighter layout */
    @media (min-width: 769px) and (max-width: 1199px) {
        .guided-questions {
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .question-item.full-width {
            grid-column: 1 / -1;
        }
        
        .question-item {
            grid-template-columns: 150px 1fr;
        }
    }
    
    /* Mobile responsiveness - extra compact */
    @media (max-width: 768px) {
        .container {
            padding: 6px 12px;
        }
        
        .writing-textarea {
            min-height: 100px;
            font-size: 16px; /* Prevent iOS zoom */
        }
        
        .entries-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
        
        .toggle-container {
            align-self: flex-end;
        }
        
        .action-buttons {
            flex-direction: column;
            gap: 6px;
            width: 100%;
        }
        
        .action-buttons button {
            width: 100%;
        }
        
        .guided-controls {
            flex-direction: column;
            gap: 8px;
            align-items: stretch;
        }
        
        .guided-action-buttons {
            justify-content: center;
        }
        
        /* Mobile specific guided questions */
        .question-item {
            grid-template-columns: 1fr;
            gap: 2px;
        }
        
        .question-item:not(.full-width) {
            grid-template-columns: 1fr;
        }
        
        .guided-section {
            padding: 8px;
        }
        
        .guided-questions {
            gap: 6px;
        }
        
        .emotion-selector {
            max-height: 60px;
        }
        
        .emotion-tag {
            font-size: 10px;
            padding: 1px 4px;
        }
        
        /* Mobile entry layout - stack content vertically */
        .entry-body {
            flex-direction: column;
            gap: 8px;
            align-items: stretch;
        }
        
        .entry-context {
            max-width: none;
            align-items: flex-start;
            flex-direction: row;
            gap: 8px;
        }
        
        .entry-weather-info,
        .entry-location-info {
            text-align: left;
            flex: 1;
            min-width: 0;
        }
    }
    
    @media (max-width: 480px) {
        .container {
            padding: 4px 8px;
        }
        
        .writing-section,
        .entries-section,
        .guided-section {
            padding: 8px;
        }
        
        .entry-item {
            padding: 6px 0;
        }
        
        /* Extra small mobile - stack context items vertically */
        .entry-context {
            flex-direction: column;
            gap: 4px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <!-- Dashboard Header - Removed for compact design -->
    
    <div class="writing-entries-container">
    <!-- Writing Section -->
    <div class="writing-section">
        <form method="POST" action="{{ url_for('journal.dashboard') }}" id="quickJournalForm">
            <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="location_data" id="quickLocationDataField" value="">
            <input type="hidden" name="weather_data" id="quickWeatherDataField" value="">
            <input type="hidden" name="photo_data" id="quickPhotoDataField" value="">
            <textarea 
                name="content" 
                id="entryContent"
                class="writing-textarea" 
                placeholder="Start writing your journal entry..." 
                spellcheck="true"
                autofocus></textarea>
            
            <div class="writing-controls">
                <span class="word-count" id="wordCount">0 words</span>
                <div class="action-buttons">
                    <div class="template-dropdown-container">
                        <select id="templateSelect" class="template-select">
                            <option value="">üéØ Guided Journal ‚ñº</option>
                            {% if system_templates %}
                                <optgroup label="System Templates">
                                    {% for template in system_templates %}
                                    <option value="{{ template.id }}">{{ template.name }}</option>
                                    {% endfor %}
                                </optgroup>
                            {% endif %}
                            {% if user_templates %}
                                <optgroup label="My Templates">
                                    {% for template in user_templates %}
                                    <option value="{{ template.id }}">{{ template.name }}</option>
                                    {% endfor %}
                                </optgroup>
                            {% endif %}
                            <option value="create">+ Create Template</option>
                        </select>
                    </div>
                    <button type="button" class="toggle-btn small-btn" id="weatherToggle" title="Add weather & location">üå§Ô∏è</button>
                    <button type="button" class="toggle-btn small-btn" id="photoToggle" title="Add photo">üì∑</button>
                    <button type="button" class="toggle-btn small-btn" id="aiToggle" title="Chat with AI">ü§ñ</button>
                    <button type="submit" class="save-btn">Save Entry</button>
                </div>
            </div>
        </form>
        
        <!-- Guided Questions Section (hidden by default) -->
        <div class="guided-section" id="guidedSection" style="display: none;">
            <div class="guided-form">
                <form method="POST" action="{{ url_for('journal.dashboard') }}" id="guidedJournalForm">
                    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="entry_type" value="guided">
                    <input type="hidden" name="template_id" id="templateIdField" value="">
                    <input type="hidden" name="location_data" id="locationDataField" value="">
                    <input type="hidden" name="weather_data" id="weatherDataField" value="">
                    <input type="hidden" name="photo_data" id="guidedPhotoDataField" value="">
                    
                    <div class="guided-questions" id="guidedQuestions">
                        <!-- Questions will be loaded dynamically -->
                    </div>
                    
                    <div class="guided-controls">
                        <span class="question-progress" id="questionProgress">Question 1 of 5</span>
                        <div class="guided-action-buttons">
                            <button type="button" class="toggle-btn" id="guidedClose">Close</button>
                            <button type="submit" class="save-btn">Save Guided Entry</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Weather and Location Section (hidden by default) -->
        <div class="weather-section" id="weatherSection" style="display: none;">
            <div class="weather-controls">
                <div class="weather-header">
                    <h3 class="weather-title">üìç Weather & Location</h3>
                    <div class="weather-actions">
                        <button type="button" class="weather-btn" id="autoDetectBtn" title="Auto-detect location & weather">üéØ Auto</button>
                        <button type="button" class="weather-btn clear-btn" id="clearWeatherBtn" title="Clear weather data">üóëÔ∏è Clear</button>
                        <button type="button" class="weather-btn" id="weatherClose" title="Close section">‚úï</button>
                    </div>
                </div>
                
                <div class="location-search-container">
                    <input type="text" id="locationInput" class="location-input" placeholder="Search location (e.g. New York, Paris)">
                    <button type="button" class="search-btn" id="searchLocationBtn" title="Search location">üîç Search</button>
                </div>
                
                <div class="weather-display" id="weatherDisplay">
                    <div class="weather-content">
                        <span class="weather-status">Click Auto to detect location & weather automatically</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Photo Capture Section (hidden by default) -->
        <div class="weather-section" id="photoSection" style="display: none;">
            <div class="weather-controls">
                <div class="weather-header">
                    <h3 class="weather-title">üì∑ Photo Capture</h3>
                    <div class="weather-actions">
                        <button type="button" class="weather-btn" id="capturePhotoBtn" title="Take photo">üì∏ Capture</button>
                        <button type="button" class="weather-btn clear-btn" id="clearPhotoBtn" title="Clear photo">üóëÔ∏è Clear</button>
                        <button type="button" class="weather-btn" id="photoClose" title="Close section">‚úï</button>
                    </div>
                </div>
                
                <div class="photo-preview-container" id="photoPreviewContainer" style="display: none;">
                    <canvas id="photoCanvas" width="320" height="240" style="border: 1px solid var(--border-color); border-radius: 4px; max-width: 100%;"></canvas>
                    <input type="hidden" id="photoDataField" name="photo_data" value="">
                </div>
                
                <video id="cameraVideo" autoplay muted style="display: none; width: 100%; max-width: 320px; border: 1px solid var(--border-color); border-radius: 4px;"></video>
                
                <div class="weather-display" id="photoDisplay">
                    <div class="weather-content">
                        <span class="weather-status">Click Capture to take a photo with your camera</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- AI Conversation Section (hidden by default) -->
        <div class="weather-section" id="aiSection" style="display: none;">
            <div class="weather-controls">
                <div class="weather-header">
                    <h3 class="weather-title">ü§ñ AI Conversation</h3>
                    <div class="weather-actions">
                        <button type="button" class="weather-btn clear-btn" id="clearAIBtn" title="Clear conversation">üóëÔ∏è Clear</button>
                        <button type="button" class="weather-btn" id="aiClose" title="Close section">‚úï</button>
                    </div>
                </div>
                
                <div class="ai-chat-container" id="aiChatContainer">
                    <div class="ai-messages" id="aiMessages" style="height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 12px; background: var(--bg-secondary); margin-bottom: 12px;"></div>
                    
                    <div class="ai-input-container" style="display: flex; gap: 8px;">
                        <input type="text" id="aiInput" class="location-input" placeholder="Ask AI about your journal entries..." style="flex: 1;">
                        <button type="button" class="search-btn" id="sendAIBtn" title="Send message">üí¨ Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Journal Entries Section -->
    <div class="entries-section">
        <div class="entries-header">
            <h2 class="entries-title">Your Journal Entries ({{ paginated_entries.total }})</h2>
            <div class="toggle-container">
                <label class="toggle-label" for="detailToggle">Detailed View</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="detailToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
        
        <div class="entries-container" id="entriesContainer">
            {% if entries %}
                {% for entry in entries %}
                <div class="entry-item entry-type {{ entry.entry_type }}" onclick="viewEntry({{ entry.id }})" style="cursor: pointer;">
                    <div class="entry-header">
                        <span class="entry-date">{{ format_datetime(entry.created_at, '%b %d, %Y at %I:%M %p') }}</span>
                    </div>
                    
                    <div class="entry-body">
                        <div class="entry-main-content">
                            {% if entry.entry_type == 'quick' %}
                                <div class="entry-content">{{ entry.content[:200] }}{% if entry.content|length > 200 %}...{% endif %}</div>
                            {% else %}
                                <!-- Guided entry summary -->
                                <div class="guided-summary">
                                    {% set feeling_response = entry.guided_responses|selectattr('question_id', 'equalto', 'feeling_scale')|first %}
                                    {% set main_response = entry.guided_responses|selectattr('question_id', 'equalto', 'main_content')|first %}
                                    {% set emotion_response = entry.guided_responses|selectattr('question_id', 'equalto', 'additional_emotions')|first %}
                                    
                                    {% if feeling_response %}
                                        <div class="feeling-indicator">
                                            {% set feeling_num = feeling_response.response|int %}
                                            {% if feeling_num >= 8 %}üòä{% elif feeling_num >= 6 %}üôÇ{% elif feeling_num >= 4 %}üòê{% else %}üòî{% endif %}
                                            {{ feeling_response.response }}/10
                                        </div>
                                    {% endif %}
                                    
                                    {% if main_response %}
                                        <div class="entry-content">{{ main_response.response[:150] }}{% if main_response.response|length > 150 %}...{% endif %}</div>
                                    {% endif %}
                                    
                                    {% if emotion_response %}
                                        <div class="emotion-tags">
                                            <span class="emotion-tag">{{ emotion_response.response[:30] }}{% if emotion_response.response|length > 30 %}...{% endif %}</span>
                                        </div>
                                    {% endif %}
                                    
                                    <!-- Detailed content (hidden by default) -->
                                    <div class="detailed-only">
                                        {% for response in entry.guided_responses %}
                                            {% if response.question_id not in ['feeling_scale', 'main_content', 'additional_emotions'] %}
                                                <div style="margin-top: 8px;">
                                                    <strong style="font-size: 11px; color: #6c757d;">{{ response.question_text }}:</strong>
                                                    <div style="font-size: 12px;">{{ response.response }}</div>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Weather and Location Context on the Right -->
                        {% if entry.location or entry.weather %}
                            <div class="entry-context">
                                {% if entry.weather %}
                                    <div class="entry-weather-info">
                                        <div class="weather-temp">{{ entry.weather.temperature|round|int }}¬∞</div>
                                        <div class="weather-condition">{{ entry.weather.weather_condition }}</div>
                                    </div>
                                {% endif %}
                                
                                {% if entry.location %}
                                    <div class="entry-location-info">
                                        <div class="location-name">üìç {{ entry.location.city }}</div>
                                        {% if entry.location.state and entry.location.state != 'Unknown' %}
                                            <div>{{ entry.location.state }}</div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="entry-actions detailed-only">
                        <span class="entry-action">Entry #{{ entry.id }}</span>
                        <span class="entry-action">{{ format_datetime(entry.created_at, '%b %d, %Y') }}</span>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: 24px; color: #6c757d; font-size: 14px;">
                    No journal entries yet. Start writing above to create your first entry!
                </div>
            {% endif %}
        </div>
        
        <!-- Pagination -->
        {% if paginated_entries.pages > 1 %}
        <div class="pagination-wrapper">
            <div class="pagination-info">
                Page {{ paginated_entries.page }} of {{ paginated_entries.pages }}
            </div>
            <div class="pagination-nav">
                {% if paginated_entries.has_prev %}
                    <a href="{{ url_for('journal.dashboard', page=paginated_entries.prev_num) }}" class="pagination-btn">Previous</a>
                {% endif %}
                
                {% for page_num in paginated_entries.iter_pages() %}
                    {% if page_num %}
                        {% if page_num != paginated_entries.page %}
                            <a href="{{ url_for('journal.dashboard', page=page_num) }}" class="pagination-btn">{{ page_num }}</a>
                        {% else %}
                            <span class="pagination-btn active">{{ page_num }}</span>
                        {% endif %}
                    {% endif %}
                {% endfor %}
                
                {% if paginated_entries.has_next %}
                    <a href="{{ url_for('journal.dashboard', page=paginated_entries.next_num) }}" class="pagination-btn">Next</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
    </div> <!-- Close writing-entries-container -->
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ csp_nonce() }}">
    // Set CSRF token for API calls
    window.csrfToken = '{{ csrf_token() }}';
    
    document.addEventListener('DOMContentLoaded', function() {
        const entryContent = document.getElementById('entryContent');
        const wordCount = document.getElementById('wordCount');
        const detailToggle = document.getElementById('detailToggle');
        const entriesContainer = document.getElementById('entriesContainer');
        
        // Word count functionality
        function updateWordCount() {
            const words = entryContent.value.trim().split(/\s+/).filter(word => word.length > 0).length;
            wordCount.textContent = words + (words === 1 ? ' word' : ' words');
        }
        
        entryContent.addEventListener('input', updateWordCount);
        
        // Auto-save functionality (optional)
        let autoSaveTimeout;
        entryContent.addEventListener('input', function() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(function() {
                // Auto-save logic can be implemented here
            }, 30000); // Auto-save after 30 seconds of inactivity
        });
        
        // Detail toggle functionality
        detailToggle.addEventListener('change', function() {
            if (this.checked) {
                entriesContainer.classList.add('show-detailed');
                localStorage.setItem('detailViewEnabled', 'true');
            } else {
                entriesContainer.classList.remove('show-detailed');
                localStorage.setItem('detailViewEnabled', 'false');
            }
        });
        
        // Load saved toggle preference
        const detailViewEnabled = localStorage.getItem('detailViewEnabled');
        if (detailViewEnabled === 'true') {
            detailToggle.checked = true;
            entriesContainer.classList.add('show-detailed');
        }
        
        // Form submission with loading state
        const quickJournalForm = document.getElementById('quickJournalForm');
        const saveBtn = quickJournalForm.querySelector('.save-btn');
        
        quickJournalForm.addEventListener('submit', function() {
            saveBtn.textContent = 'Saving...';
            saveBtn.disabled = true;
        });
        
        // Focus on writing area when page loads
        entryContent.focus();
        
        // Template and guided journal functionality
        const templateSelect = document.getElementById('templateSelect');
        const guidedSection = document.getElementById('guidedSection');
        const guidedClose = document.getElementById('guidedClose');
        const guidedQuestions = document.getElementById('guidedQuestions');
        const weatherToggle = document.getElementById('weatherToggle');
        const weatherSection = document.getElementById('weatherSection');
        const weatherClose = document.getElementById('weatherClose');
        const autoDetectBtn = document.getElementById('autoDetectBtn');
        const clearWeatherBtn = document.getElementById('clearWeatherBtn');
        const searchLocationBtn = document.getElementById('searchLocationBtn');
        const locationInput = document.getElementById('locationInput');
        const weatherDisplay = document.getElementById('weatherDisplay');
        
        // Photo capture elements
        const photoToggle = document.getElementById('photoToggle');
        const photoSection = document.getElementById('photoSection');
        const photoClose = document.getElementById('photoClose');
        const capturePhotoBtn = document.getElementById('capturePhotoBtn');
        const clearPhotoBtn = document.getElementById('clearPhotoBtn');
        const cameraVideo = document.getElementById('cameraVideo');
        const photoCanvas = document.getElementById('photoCanvas');
        const photoDisplay = document.getElementById('photoDisplay');
        const photoPreviewContainer = document.getElementById('photoPreviewContainer');
        
        // AI conversation elements
        const aiToggle = document.getElementById('aiToggle');
        const aiSection = document.getElementById('aiSection');
        const aiClose = document.getElementById('aiClose');
        const clearAIBtn = document.getElementById('clearAIBtn');
        const aiInput = document.getElementById('aiInput');
        const sendAIBtn = document.getElementById('sendAIBtn');
        const aiMessages = document.getElementById('aiMessages');
        
        // Only proceed if critical elements exist
        if (!templateSelect || !guidedSection) {
            return;
        }
        
        let isGuidedMode = false;
        let isWeatherMode = false;
        let isPhotoMode = false;
        let isAIMode = false;
        let currentTemplateId = null;
        let currentLocationData = null;
        let currentWeatherData = null;
        let currentPhotoData = null;
        let cameraStream = null;
        let aiConversationHistory = [];
        let isAIRequestInProgress = false;
        
        // Streamlined guided journal - auto-start on first interaction
        let hasInteractedWithTemplate = false;
        
        templateSelect.addEventListener('click', function() {
            // Auto-start default guided journal on first click (streamlined UX)
            if (!isGuidedMode && !hasInteractedWithTemplate) {
                hasInteractedWithTemplate = true;
                currentTemplateId = null;
                showGuidedSection();
                // Update dropdown text to show it's active
                this.options[0].textContent = 'üìù Active (Click to change)';
                // Close dropdown after starting guided journal
                this.blur();
            }
        });
        
        // Template selection for changing templates
        templateSelect.addEventListener('change', function() {
            const value = this.value;
            hasInteractedWithTemplate = true;
            
            if (value === 'create') {
                // Redirect to template creation
                window.open('/journal/create_template', '_blank');
                this.value = ''; // Reset selection
                this.options[0].textContent = 'üéØ Guided Journal ‚ñº';
                this.blur();
            } else if (value === '') {
                // Default guided mode
                currentTemplateId = null;
                showGuidedSection();
                this.options[0].textContent = 'üìù Active (Click to change)';
                this.blur();
            } else {
                // Load specific template
                currentTemplateId = value;
                showGuidedSection(value);
                this.blur();
            }
        });
        
        // Weather toggle - Now automatically detects when opened
        weatherToggle.addEventListener('click', function() {
            if (isWeatherMode) {
                hideWeatherSection();
            } else {
                showWeatherSection();
                // Automatically detect location when opened
                autoDetectLocation();
            }
        });
        
        // Photo toggle - Immediately starts camera
        photoToggle.addEventListener('click', function() {
            if (isPhotoMode) {
                hidePhotoSection();
            } else {
                showPhotoSection();
                // Automatically start camera when opened
                startCamera();
            }
        });
        
        // AI toggle
        aiToggle.addEventListener('click', function() {
            if (isAIMode) {
                hideAISection();
            } else {
                showAISection();
            }
        });
        
        // New streamlined weather controls
        autoDetectBtn.addEventListener('click', autoDetectLocation);
        
        clearWeatherBtn.addEventListener('click', function() {
            clearWeatherData();
        });
        
        searchLocationBtn.addEventListener('click', function() {
            const location = locationInput.value.trim();
            if (location) {
                searchLocation(location);
            } else {
                alert('Please enter a location to search');
            }
        });
        
        // Allow Enter key in location search
        locationInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const location = this.value.trim();
                if (location) {
                    searchLocation(location);
                }
            }
        });
        
        weatherClose.addEventListener('click', function() {
            hideWeatherSection();
        });
        
        // Photo event listeners
        photoClose.addEventListener('click', function() {
            hidePhotoSection();
        });
        
        capturePhotoBtn.addEventListener('click', function() {
            capturePhoto();
        });
        
        clearPhotoBtn.addEventListener('click', function() {
            clearPhotoData();
        });
        
        // AI event listeners
        aiClose.addEventListener('click', function() {
            hideAISection();
        });
        
        sendAIBtn.addEventListener('click', function() {
            sendAIMessage();
        });
        
        clearAIBtn.addEventListener('click', function() {
            clearAIConversation();
        });
        
        aiInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendAIMessage();
            }
        });
        
        guidedClose.addEventListener('click', function() {
            hideGuidedSection();
        });
        
        function showGuidedSection(templateId = null) {
            isGuidedMode = true;
            guidedSection.style.display = 'block';
            
            // Set template ID in hidden field
            document.getElementById('templateIdField').value = templateId || '';
            
            if (templateId) {
                loadTemplate(templateId);
            } else {
                loadGuidedQuestions();
            }
        }
        
        function hideGuidedSection() {
            isGuidedMode = false;
            guidedSection.style.display = 'none';
            templateSelect.value = '';
            currentTemplateId = null;
            hasInteractedWithTemplate = false;
            // Reset dropdown text to initial state
            templateSelect.options[0].textContent = 'üéØ Guided Journal ‚ñº';
        }
        
        function showWeatherSection() {
            isWeatherMode = true;
            weatherToggle.classList.add('active');
            weatherSection.style.display = 'block';
        }
        
        function hideWeatherSection() {
            isWeatherMode = false;
            weatherToggle.classList.remove('active');
            weatherSection.style.display = 'none';
        }
        
        function showPhotoSection() {
            isPhotoMode = true;
            photoToggle.classList.add('active');
            photoSection.style.display = 'block';
        }
        
        function hidePhotoSection() {
            isPhotoMode = false;
            photoToggle.classList.remove('active');
            photoSection.style.display = 'none';
            stopCamera();
        }
        
        function showAISection() {
            isAIMode = true;
            aiToggle.classList.add('active');
            aiSection.style.display = 'block';
            // Initialize AI conversation with welcome message
            if (aiConversationHistory.length === 0) {
                addAIMessage('ai', 'Hi! I\'m here to help you reflect on your journal entries. Ask me anything about your journaling patterns, emotions, or get insights about your entries!');
            }
        }
        
        function hideAISection() {
            isAIMode = false;
            aiToggle.classList.remove('active');
            aiSection.style.display = 'none';
        }
        
        // Auto-detect location - streamlined single click
        function autoDetectLocation() {
            if (navigator.geolocation) {
                autoDetectBtn.textContent = '‚è≥ Detecting...';
                autoDetectBtn.disabled = true;
                
                showWeatherLoading('Detecting your location...');
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        
                        // Get location name and weather
                        fetchLocationAndWeather(lat, lon);
                    },
                    function(error) {
                        autoDetectBtn.textContent = 'üéØ Auto';
                        autoDetectBtn.disabled = false;
                        showWeatherError('Unable to get location: ' + error.message);
                    },
                    { timeout: 10000, enableHighAccuracy: true }
                );
            } else {
                showWeatherError('Geolocation is not supported by this browser');
            }
        }
        
        // Search for location by name
        function searchLocation(locationName) {
            searchLocationBtn.textContent = '‚è≥';
            searchLocationBtn.disabled = true;
            
            showWeatherLoading(`Searching for "${locationName}"...`);
            
            // Simulate location search (in real implementation, use geocoding API)
            setTimeout(() => {
                // Mock data - replace with real geocoding API
                const mockLocationData = {
                    latitude: 40.7128,
                    longitude: -74.0060,
                    name: locationName,
                    city: locationName.split(',')[0].trim(),
                    state: locationName.split(',')[1]?.trim() || 'Unknown',
                    country: 'US',
                    address: locationName
                };
                
                currentLocationData = mockLocationData;
                locationInput.value = locationName;
                
                // Fetch weather for this location
                fetchWeatherForLocation(mockLocationData);
                
                searchLocationBtn.textContent = 'üîç Search';
                searchLocationBtn.disabled = false;
            }, 1500);
        }
        
        // Clear all weather and location data
        function clearWeatherData() {
            currentLocationData = null;
            currentWeatherData = null;
            locationInput.value = '';
            
            showWeatherStatus('Weather and location cleared');
            
            // Clear hidden form fields
            document.getElementById('quickLocationDataField').value = '';
            document.getElementById('quickWeatherDataField').value = '';
            document.getElementById('locationDataField').value = '';
            document.getElementById('weatherDataField').value = '';
        }
        
        async function fetchLocationAndWeather(lat, lon) {
            showWeatherLoading('Getting location details...');
            
            try {
                // Use the real reverse geocoding API
                const response = await fetch('/api/location/reverse-geocode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': window.csrfToken
                    },
                    body: JSON.stringify({
                        latitude: lat,
                        longitude: lon
                    })
                });
                
                if (response.ok) {
                    const locationInfo = await response.json();
                    
                    // Create location data with proper city/state
                    const locationData = {
                        latitude: lat,
                        longitude: lon,
                        name: locationInfo.city && locationInfo.state ? 
                            `${locationInfo.city}, ${locationInfo.state}` : 
                            locationInfo.name || 'Current Location',
                        city: locationInfo.city || 'Unknown',
                        state: locationInfo.state || 'Unknown',
                        country: locationInfo.country || 'Unknown',
                        address: locationInfo.address || `${lat.toFixed(4)}, ${lon.toFixed(4)}`,
                        location_type: 'gps'
                    };
                    
                    currentLocationData = locationData;
                    locationInput.value = locationData.name;
                    
                    fetchWeatherForLocation(locationData);
                } else {
                    // Fallback to coordinates if geocoding fails
                    const locationData = {
                        latitude: lat,
                        longitude: lon,
                        name: `${lat.toFixed(4)}, ${lon.toFixed(4)}`,
                        city: 'Current Location',
                        state: 'GPS',
                        country: 'Auto-detected',
                        address: `${lat.toFixed(4)}, ${lon.toFixed(4)}`,
                        location_type: 'gps'
                    };
                    
                    currentLocationData = locationData;
                    locationInput.value = locationData.name;
                    
                    fetchWeatherForLocation(locationData);
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                showWeatherError('Failed to get location information');
            }
        }
        
        async function fetchWeatherForLocation(locationData) {
            showWeatherLoading('Getting weather data...');
            
            try {
                // Use the real weather API
                const response = await fetch('/api/weather/current', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': window.csrfToken
                    },
                    body: JSON.stringify({
                        latitude: locationData.latitude,
                        longitude: locationData.longitude
                    })
                });
                
                if (response.ok) {
                    const weatherApiData = await response.json();
                    
                    // Convert API response to our display format
                    const weatherData = {
                        temperature: Math.round(weatherApiData.temperature),
                        condition: weatherApiData.weather_condition,
                        humidity: weatherApiData.humidity,
                        location: locationData.name,
                        wind_speed: weatherApiData.wind_speed,
                        description: weatherApiData.weather_description
                    };
                    
                    currentWeatherData = weatherData;
                    
                    showWeatherData(locationData, weatherData);
                    updateFormFields();
                    
                    autoDetectBtn.textContent = 'üéØ Auto';
                    autoDetectBtn.disabled = false;
                } else {
                    showWeatherError('Failed to get weather data');
                    autoDetectBtn.textContent = 'üéØ Auto';
                    autoDetectBtn.disabled = false;
                }
            } catch (error) {
                console.error('Weather API error:', error);
                showWeatherError('Weather service unavailable');
                autoDetectBtn.textContent = 'üéØ Auto';
                autoDetectBtn.disabled = false;
            }
        }
        
        function showWeatherData(locationData, weatherData) {
            const weatherContent = `
                <div class="weather-info">
                    <div class="weather-temp">${weatherData.temperature}¬∞F</div>
                    <div class="weather-condition">${weatherData.condition}</div>
                    <div class="location-info">üìç ${locationData.city}, ${locationData.state}</div>
                    <div class="weather-details">
                        <small class="text-muted">
                            ${weatherData.humidity}% humidity
                            ${weatherData.wind_speed ? ` ‚Ä¢ ${Math.round(weatherData.wind_speed)} mph wind` : ''}
                        </small>
                    </div>
                </div>
            `;
            
            weatherDisplay.innerHTML = weatherContent;
        }
        
        function showWeatherLoading(message) {
            weatherDisplay.innerHTML = `<div class="weather-content"><span class="weather-loading">${message}</span></div>`;
        }
        
        function showWeatherStatus(message) {
            weatherDisplay.innerHTML = `<div class="weather-content"><span class="weather-status">${message}</span></div>`;
        }
        
        function showWeatherError(message) {
            weatherDisplay.innerHTML = `<div class="weather-content"><span class="weather-status" style="color: #dc3545;">${message}</span></div>`;
        }
        
        function updateFormFields() {
            const locationJSON = currentLocationData ? JSON.stringify(currentLocationData) : '';
            const weatherJSON = currentWeatherData ? JSON.stringify(currentWeatherData) : '';
            const photoJSON = currentPhotoData ? JSON.stringify(currentPhotoData) : '';
            
            // Update hidden fields for both forms
            document.getElementById('quickLocationDataField').value = locationJSON;
            document.getElementById('quickWeatherDataField').value = weatherJSON;
            document.getElementById('quickPhotoDataField').value = photoJSON;
            document.getElementById('locationDataField').value = locationJSON;
            document.getElementById('weatherDataField').value = weatherJSON;
            document.getElementById('guidedPhotoDataField').value = photoJSON;
        }
        
        function loadTemplate(templateId) {
            // Load template questions from server
            fetch(`/api/templates/${templateId}/questions`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderTemplateQuestions(data.questions);
                        document.getElementById('questionProgress').textContent = `${data.questions.length} questions (${data.template_name})`;
                    } else {
                        console.error('Failed to load template:', data.error);
                        loadGuidedQuestions(); // Fallback to default
                    }
                })
                .catch(error => {
                    console.error('Error loading template:', error);
                    loadGuidedQuestions(); // Fallback to default
                });
        }
        
        function renderTemplateQuestions(questions) {
            guidedQuestions.innerHTML = '';
            
            questions.forEach(question => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                questionDiv.id = `question_${question.question_id}`;
                
                if (question.question_type === 'text' && question.properties && JSON.parse(question.properties || '{}').multiline) {
                    questionDiv.classList.add('full-width');
                }
                
                let inputHtml = '';
                
                if (question.question_type === 'number') {
                    const props = JSON.parse(question.properties || '{}');
                    const min = props.min || 1;
                    const max = props.max || 10;
                    const defaultVal = Math.floor((min + max) / 2);
                    
                    inputHtml = `
                        <div class="feeling-scale-container">
                            <input type="range" name="${question.question_id}" class="feeling-slider" 
                                   min="${min}" max="${max}" value="${defaultVal}" id="${question.question_id}_slider">
                            <div class="feeling-display">
                                <span>üò≠</span>
                                <div class="feeling-current">
                                    <span id="${question.question_id}_value">${defaultVal}</span>
                                    <span id="${question.question_id}_emoji" class="feeling-emoji">üòê</span>
                                </div>
                                <span>ü§©</span>
                            </div>
                        </div>
                    `;
                } else if (question.question_type === 'emotions') {
                    const emotions = {
                        positive: ['Happy', 'Excited', 'Grateful', 'Proud', 'Confident', 'Peaceful', 'Loved', 'Optimistic'],
                        negative: ['Sad', 'Angry', 'Anxious', 'Frustrated', 'Disappointed', 'Lonely', 'Overwhelmed', 'Stressed'],
                        neutral: ['Calm', 'Curious', 'Reflective', 'Tired', 'Focused', 'Content', 'Indifferent', 'Thoughtful']
                    };
                    
                    let emotionTags = '';
                    Object.entries(emotions).forEach(([category, emotionList]) => {
                        emotionList.forEach(emotion => {
                            emotionTags += `<span class="emotion-tag ${category}" data-emotion="${emotion}">${emotion}</span>`;
                        });
                    });
                    
                    inputHtml = `
                        <div class="emotion-selector">${emotionTags}</div>
                        <input type="hidden" name="${question.question_id}" id="${question.question_id}_selected" value="">
                    `;
                } else if (question.question_type === 'boolean') {
                    inputHtml = `
                        <div class="form-check-inline" style="display: flex; gap: 12px;">
                            <label><input type="radio" name="${question.question_id}" value="Yes" style="margin-right: 4px;"> Yes</label>
                            <label><input type="radio" name="${question.question_id}" value="No" style="margin-right: 4px;"> No</label>
                        </div>
                    `;
                } else {
                    const props = JSON.parse(question.properties || '{}');
                    if (props.multiline) {
                        inputHtml = `<textarea name="${question.question_id}" class="question-input textarea" rows="2" placeholder="Share your thoughts..."></textarea>`;
                    } else {
                        inputHtml = `<input type="text" name="${question.question_id}" class="question-input" placeholder="Enter your response...">`;
                    }
                }
                
                questionDiv.innerHTML = `
                    <label class="question-label">${question.question_text}</label>
                    ${inputHtml}
                `;
                
                guidedQuestions.appendChild(questionDiv);
            });
            
            // Set up interactive functionality for template questions
            setupFeelingSlider();
            setupEmotionSelector();
        }
        
        function loadGuidedQuestions() {
            // All guided questions from original system
            const questions = [
                {
                    id: 'feeling_scale',
                    text: 'How are you feeling?',
                    type: 'slider',
                    required: true
                },
                {
                    id: 'additional_emotions',
                    text: 'Select emotions',
                    type: 'emotions',
                    required: false
                },
                {
                    id: 'feeling_reason',
                    text: 'Why do you feel that way?',
                    type: 'textarea',
                    required: false
                },
                {
                    id: 'about_day',
                    text: 'Tell me about your day',
                    type: 'textarea',
                    required: true
                },
                {
                    id: 'exercise',
                    text: 'Did you exercise today?',
                    type: 'boolean',
                    required: false
                },
                {
                    id: 'exercise_type',
                    text: 'What type of workout?',
                    type: 'text',
                    required: false,
                    dependsOn: 'exercise'
                },
                {
                    id: 'anything_else',
                    text: 'Anything else to discuss?',
                    type: 'textarea',
                    required: false
                }
            ];
            
            guidedQuestions.innerHTML = '';
            
            questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                questionDiv.id = `question_${question.id}`;
                
                if (question.type === 'textarea') {
                    questionDiv.classList.add('full-width');
                }
                
                if (question.dependsOn) {
                    questionDiv.style.display = 'none';
                }
                
                let inputHtml = '';
                
                if (question.type === 'slider') {
                    inputHtml = `
                        <div class="feeling-scale-container">
                            <input type="range" name="${question.id}" class="feeling-slider" 
                                   min="1" max="10" value="5" id="${question.id}_slider">
                            <div class="feeling-display">
                                <span>üò≠</span>
                                <div class="feeling-current">
                                    <span id="${question.id}_value">5</span>
                                    <span id="${question.id}_emoji" class="feeling-emoji">üòê</span>
                                </div>
                                <span>ü§©</span>
                            </div>
                        </div>
                    `;
                } else if (question.type === 'emotions') {
                    const emotions = {
                        positive: ['Happy', 'Excited', 'Grateful', 'Proud', 'Confident', 'Peaceful', 'Loved', 'Optimistic'],
                        negative: ['Sad', 'Angry', 'Anxious', 'Frustrated', 'Disappointed', 'Lonely', 'Overwhelmed', 'Stressed'],
                        neutral: ['Calm', 'Curious', 'Reflective', 'Tired', 'Focused', 'Content', 'Indifferent', 'Thoughtful']
                    };
                    
                    let emotionTags = '';
                    Object.entries(emotions).forEach(([category, emotionList]) => {
                        emotionList.forEach(emotion => {
                            emotionTags += `<span class="emotion-tag ${category}" data-emotion="${emotion}">${emotion}</span>`;
                        });
                    });
                    
                    inputHtml = `
                        <div class="emotion-selector">${emotionTags}</div>
                        <input type="hidden" name="${question.id}" id="${question.id}_selected" value="">
                    `;
                } else if (question.type === 'boolean') {
                    inputHtml = `
                        <div class="form-check-inline" style="display: flex; gap: 12px;">
                            <label><input type="radio" name="${question.id}" value="Yes" style="margin-right: 4px;"> Yes</label>
                            <label><input type="radio" name="${question.id}" value="No" style="margin-right: 4px;"> No</label>
                        </div>
                    `;
                } else if (question.type === 'textarea') {
                    inputHtml = `<textarea name="${question.id}" class="question-input textarea" rows="2" placeholder="Share your thoughts..."></textarea>`;
                } else {
                    inputHtml = `<input type="text" name="${question.id}" class="question-input" placeholder="Optional">`;
                }
                
                questionDiv.innerHTML = `
                    <label class="question-label">${question.text}</label>
                    ${inputHtml}
                `;
                
                guidedQuestions.appendChild(questionDiv);
            });
            
            // Set up interactive functionality
            setupFeelingSlider();
            setupEmotionSelector();
            setupConditionalQuestions();
            
            // Update progress
            document.getElementById('questionProgress').textContent = `${questions.length} questions`;
        }
        
        function setupFeelingSlider() {
            const slider = document.getElementById('feeling_scale_slider');
            const valueDisplay = document.getElementById('feeling_scale_value');
            const emojiDisplay = document.getElementById('feeling_scale_emoji');
            
            if (slider && valueDisplay && emojiDisplay) {
                slider.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    valueDisplay.textContent = value;
                    
                    // Update emoji based on value
                    const emojis = ['', 'üò≠', 'üò¢', 'üòû', 'üòî', 'üòê', 'üôÇ', 'üòä', 'üòÑ', 'üòÅ', 'ü§©'];
                    emojiDisplay.textContent = emojis[value] || '‚ùì';
                });
            }
        }
        
        function setupEmotionSelector() {
            const emotionTags = document.querySelectorAll('.emotion-tag');
            const selectedInput = document.getElementById('additional_emotions_selected');
            let selectedEmotions = [];
            
            emotionTags.forEach(tag => {
                tag.addEventListener('click', function() {
                    const emotion = this.dataset.emotion;
                    
                    if (this.classList.contains('selected')) {
                        this.classList.remove('selected');
                        selectedEmotions = selectedEmotions.filter(e => e !== emotion);
                    } else {
                        this.classList.add('selected');
                        selectedEmotions.push(emotion);
                    }
                    
                    if (selectedInput) {
                        selectedInput.value = JSON.stringify(selectedEmotions);
                    }
                });
            });
        }
        
        function setupConditionalQuestions() {
            const exerciseRadios = document.querySelectorAll('input[name="exercise"]');
            const exerciseTypeQuestion = document.getElementById('question_exercise_type');
            
            exerciseRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (exerciseTypeQuestion) {
                        if (this.value === 'Yes') {
                            exerciseTypeQuestion.style.display = 'grid';
                        } else {
                            exerciseTypeQuestion.style.display = 'none';
                        }
                    }
                });
            });
        }
        
        // Photo capture functions
        async function startCamera() {
            try {
                showPhotoStatus('Starting camera...');
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: 640, 
                        height: 480,
                        facingMode: 'environment' // Use back camera on mobile
                    }
                });
                
                cameraStream = stream;
                cameraVideo.srcObject = stream;
                cameraVideo.style.display = 'block';
                photoPreviewContainer.style.display = 'none';
                
                showPhotoStatus('Camera ready - click Capture to take photo');
            } catch (error) {
                console.error('Error accessing camera:', error);
                showPhotoError('Unable to access camera: ' + error.message);
            }
        }
        
        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
                cameraVideo.style.display = 'none';
                cameraVideo.srcObject = null;
            }
        }
        
        function capturePhoto() {
            if (!cameraStream) {
                showPhotoError('Camera not available');
                return;
            }
            
            const canvas = photoCanvas;
            const context = canvas.getContext('2d');
            
            // Set canvas size to match video
            canvas.width = cameraVideo.videoWidth;
            canvas.height = cameraVideo.videoHeight;
            
            // Draw video frame to canvas
            context.drawImage(cameraVideo, 0, 0);
            
            // Convert to base64
            const photoDataUrl = canvas.toDataURL('image/jpeg', 0.8);
            
            // Store photo data
            currentPhotoData = {
                data: photoDataUrl,
                timestamp: new Date().toISOString(),
                width: canvas.width,
                height: canvas.height
            };
            
            // Show preview
            photoPreviewContainer.style.display = 'block';
            cameraVideo.style.display = 'none';
            
            // Update form fields
            updateFormFields();
            
            showPhotoStatus('Photo captured! Click Clear to retake or close to continue');
        }
        
        function clearPhotoData() {
            currentPhotoData = null;
            photoPreviewContainer.style.display = 'none';
            
            // Clear form fields
            document.getElementById('quickPhotoDataField').value = '';
            document.getElementById('guidedPhotoDataField').value = '';
            
            // Restart camera if section is still open
            if (isPhotoMode) {
                startCamera();
            }
        }
        
        function showPhotoStatus(message) {
            photoDisplay.innerHTML = `<div class="weather-content"><span class="weather-status">${message}</span></div>`;
        }
        
        function showPhotoError(message) {
            photoDisplay.innerHTML = `<div class="weather-content"><span class="weather-status" style="color: #dc3545;">${message}</span></div>`;
        }
        
        // AI conversation functions
        function addAIMessage(sender, message) {
            const messageDiv = document.createElement('div');
            messageDiv.style.marginBottom = '12px';
            messageDiv.style.padding = '8px 12px';
            messageDiv.style.borderRadius = '8px';
            messageDiv.style.maxWidth = '85%';
            
            if (sender === 'user') {
                messageDiv.style.backgroundColor = 'var(--accent-color)';
                messageDiv.style.color = 'white';
                messageDiv.style.marginLeft = 'auto';
                messageDiv.style.textAlign = 'right';
            } else {
                messageDiv.style.backgroundColor = 'var(--bg-primary)';
                messageDiv.style.color = 'var(--text-primary)';
                messageDiv.style.border = '1px solid var(--border-color)';
            }
            
            messageDiv.textContent = message;
            aiMessages.appendChild(messageDiv);
            aiMessages.scrollTop = aiMessages.scrollHeight;
            
            // Add to conversation history
            aiConversationHistory.push({sender, message, timestamp: new Date()});
        }
        
        function sendAIMessage() {
            const message = aiInput.value.trim();
            if (!message) return;
            
            // Prevent multiple simultaneous requests
            if (isAIRequestInProgress) {
                console.log('AI request already in progress, ignoring duplicate request');
                return;
            }
            
            // Set request in progress flag
            isAIRequestInProgress = true;
            
            // Disable UI elements to prevent multiple submissions
            aiInput.disabled = true;
            sendAIBtn.disabled = true;
            
            // Add user message
            addAIMessage('user', message);
            aiInput.value = '';
            
            // Limit conversation history to prevent memory issues (keep last 20 messages)
            const limitedHistory = aiConversationHistory.slice(-20);
            
            // Show thinking indicator with unique identifier
            const thinkingId = 'thinking-' + Date.now();
            const thinkingDiv = document.createElement('div');
            thinkingDiv.id = thinkingId;
            thinkingDiv.style.marginBottom = '12px';
            thinkingDiv.style.padding = '8px 12px';
            thinkingDiv.style.backgroundColor = 'var(--bg-primary)';
            thinkingDiv.style.border = '1px solid var(--border-color)';
            thinkingDiv.style.borderRadius = '8px';
            thinkingDiv.style.color = 'var(--text-secondary)';
            thinkingDiv.style.fontStyle = 'italic';
            thinkingDiv.textContent = 'AI is thinking...';
            aiMessages.appendChild(thinkingDiv);
            aiMessages.scrollTop = aiMessages.scrollHeight;
            
            // Send to AI endpoint with timeout
            const timeoutId = setTimeout(() => {
                console.error('AI request timeout');
                cleanup();
                addAIMessage('ai', 'Sorry, the request timed out. Please try again.');
            }, 30000); // 30 second timeout
            
            function cleanup() {
                // Clear timeout
                clearTimeout(timeoutId);
                
                // Re-enable UI elements
                aiInput.disabled = false;
                sendAIBtn.disabled = false;
                isAIRequestInProgress = false;
                
                // Remove thinking indicator if it exists
                const thinkingElement = document.getElementById(thinkingId);
                if (thinkingElement) {
                    thinkingElement.remove();
                }
            }
            
            fetch('/ai/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': window.csrfToken
                },
                body: JSON.stringify({
                    message: message,
                    conversation_history: limitedHistory
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                cleanup();
                
                if (data.success && data.response) {
                    addAIMessage('ai', data.response);
                } else {
                    const errorMsg = data.error || 'Unknown error occurred';
                    addAIMessage('ai', `Sorry, I encountered an error: ${errorMsg}. Please try again.`);
                }
            })
            .catch(error => {
                console.error('AI chat error:', error);
                cleanup();
                addAIMessage('ai', 'Sorry, I\'m having trouble connecting. Please try again.');
            });
        }
        
        function clearAIConversation() {
            // Reset conversation state
            aiMessages.innerHTML = '';
            aiConversationHistory = [];
            
            // Reset UI state in case there was an ongoing request
            aiInput.disabled = false;
            sendAIBtn.disabled = false;
            isAIRequestInProgress = false;
            
            // Add welcome message
            addAIMessage('ai', 'Hi! I\'m here to help you reflect on your journal entries. Ask me anything about your journaling patterns, emotions, or get insights about your entries!');
        }
    });
    
    // Handle clicking on journal entries
    function viewEntry(entryId) {
        window.location.href = `/entry/${entryId}`;
    }
</script>
{% endblock %}